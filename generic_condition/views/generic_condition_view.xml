<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <menuitem id="menu_generic_condition_root" name="Generic Conditions"
              parent="base.menu_custom" />

    <!-- Generic Condition Views -->
    <record id="generic_condition_search_view" model="ir.ui.view">
        <field name="name">generic.condition.search</field>
        <field name="model">generic.condition</field>
        <field name="arch" type="xml">
            <search string="Condition search">
                <field name="name"/>
                <field name="model_id"/>

                <separator/>
                <filter name="with_sudo"
                        domain="[('with_sudo', '=', True)]"
                        string="With sudo"/>
                <filter name="type_eval"
                        domain="[('type', '=', 'eval')]"
                        string="Expression"/>
                <filter name="type_filter"
                        domain="[('type', '=', 'filter')]"
                        string="Filter"/>

                <!--<filter name="type_tags"-->
                <!--domain="[('type', '=', 'tags')]"-->
                <!--string="Tags"/>-->
                <filter name="type_condition"
                        domain="[('type', '=', 'condition')]"
                        string="Condition"/>
                <filter name="type_related_conditions"
                        domain="[('type', '=', 'related_conditions')]"
                        string="Related conditions"/>
                <filter name="type_date_diff"
                        domain="[('type', '=', 'date_diff')]"
                        string="Date difference"/>
                <filter name="type_condition_group"
                        domain="[('type', '=', 'condition_group')]"
                        string="Condition group"/>
                <separator/>

                <group expand="0" string="Group by...">
                    <filter string='Type'
                            domain="[]"
                            context="{'group_by' : 'type'}"/>
                    <filter string='With sudo'
                            domain="[]"
                            context="{'group_by' : 'with_sudo'}"/>
                    <filter string='Based on'
                            domain="[]"
                            context="{'group_by' : 'model_id'}"/>
                </group>

            </search>
        </field>
    </record>

    <record id="generic_condition_tree_view" model="ir.ui.view">
        <field name="name">generic.condition.tree</field>
        <field name="model">generic.condition</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name"/>
                <field name="sequence" invisible="1"/>
                <field name="type"/>
                <field name="model_id"/>
                <field name="enable_caching"/>
                <field name="with_sudo"/>
            </tree>
        </field>
    </record>

    <record id="generic_condition_form_view" model="ir.ui.view">
        <field name="name">generic.condition.form</field>
        <field name="model">generic.condition</field>
        <field name="arch" type="xml">
            <form string="Condition">
                <sheet>
                    <field name="sequence" invisible="1"/>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                   options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="model_id"/>
                            <field name="based_on" invisible="1"/>
                            <field name="type"/>
                        </group>
                        <group>
                            <field name="enable_caching"/>
                            <field name="invert"/>
                            <field name="with_sudo"/>
                        </group>
                    </group>
                    <group string="Condition" colspan="4">

                        <!-- 'Filter' condition data -->
                        <group colspan="4" name="group_condition_filter"
                               attrs="{'invisible': [('type', '!=', 'filter')]}">
                            <field name="condition_filter_id"
                                   domain="[('model_id','=',based_on)]"
                                   context="{'default_model_id': based_on}"
                                   attrs="{'required': [('type','=','filter')]}"/>
                        </group>

                        <!-- 'Condition' condition data -->
                        <group colspan="4" name="group_condition_condition"
                               attrs="{'invisible': [('type', '!=', 'condition')]}">
                            <field name="condition_condition_id"
                                   attrs="{'required': [('type','=','condition')]}"
                                   context="{'default_model_id': model_id}"
                                   domain="[('model_id','=',model_id)]"/>
                        </group>

                        <!-- 'Eval' condition data -->
                        <group colspan="4" name="group_condition_eval"
                               attrs="{'invisible': [('type', '!=', 'eval')]}">
                            <field name="condition_eval"
                                   widget="code" ace-mode="python"
                                   attrs="{'required': [('type','=','eval')]}"/>
                        </group>

                        <!-- 'Condition group' condition data -->
                        <group colspan="4" name="group_condition_group"
                               attrs="{'invisible': [('type', '!=', 'condition_group')]}">
                            <field name="condition_condition_ids_operator"
                                   attrs="{'required': [('type','=','condition_group')]}"/>
                            <field name="condition_condition_ids"
                                   attrs="{'required': [('type','=','condition_group')]}"
                                   context="{'default_model_id': model_id}"
                                   domain="[('model_id','=',model_id)]"
                                   widget="many2many_tags"
                                   options="{'no_quick_create': true}"/>

                        </group>

                        <!-- 'Related condition' condition data -->
                        <field name="condition_rel_field_id_model_id" invisible="1"/>
                        <group colspan="4" col="4"
                               name="group_condition_related_conditions"
                               attrs="{'invisible': [('type', '!=', 'related_conditions')]}">
                            <table colspan="4" class="generic_condition_definition">
                                <tr>
                                    <td>
                                        <label for="condition_rel_field_id"/>
                                    </td>
                                    <td>
                                        <field name="condition_rel_record_operator"
                                               attrs="{'required': [('type','=','related_conditions')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_rel_field_id"
                                               attrs="{'required': [('type','=','related_conditions')]}"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id),('ttype', 'in', ('many2many', 'one2many', 'many2one'))]"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label for="condition_rel_filter_conditions"/>
                                    </td>
                                    <td>
                                        <field name="condition_rel_filter_conditions_operator"/></td>
                                    <td>
                                        <field name="condition_rel_filter_conditions"
                                               context="{'default_model_id': condition_rel_field_id_model_id}"
                                               domain="[('model_id','=',condition_rel_field_id_model_id)]"
                                               widget="many2many_tags"
                                               options="{'no_quick_create': true}"/></td>
                                </tr>
                                <tr>
                                    <td>
                                        <label for="condition_rel_conditions"/></td>
                                    <td>
                                        <field name="condition_rel_conditions_operator"
                                               attrs="{'required': [('type','=','related_conditions')]}"/></td>
                                    <td>
                                        <field name="condition_rel_conditions"
                                               attrs="{'required': [('type','=','related_conditions')]}"
                                               context="{'default_model_id': condition_rel_field_id_model_id}"
                                               domain="[('model_id','=',condition_rel_field_id_model_id)]"
                                               widget="many2many_tags"
                                               options="{'no_quick_create': true}"/></td>
                                </tr>
                            </table>
                        </group>

                        <!-- 'Current user' condition data -->
                        <group colspan="4" col="4"
                               name="group_condition_current_user"
                               attrs="{'invisible': [('type', '!=', 'current_user')]}">
                            <field name="condition_user_user_field_id"
                                   attrs="{'required': [('type','=','current_user')]}"
                                   domain="[('model_id','=',model_id),
                                            ('ttype', 'in', ('many2one', 'one2many', 'many2many')),
                                            ('relation', '=', 'res.users')]"/>
                        </group>

                        <!-- 'Date diff' condition data -->
                        <group colspan="4" col="4"
                               name="group_condition_date_diff"
                               attrs="{'invisible': [('type', '!=', 'date_diff')]}">

                            <table colspan="4" class="generic_condition_definition">
                                <tr>
                                    <td>
                                        <label string="End Date"/>
                                    </td>
                                    <td>
                                        &#160; &#160; &#160; &#160;
                                    </td>
                                    <td>
                                        <label string="Start Date"/>
                                    </td>
                                    <td>
                                        <label string="Operator"/>
                                    </td>
                                    <td>
                                        <label string="Result"/>
                                    </td>
                                    <td>
                                        <label for="condition_date_diff_absolute"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <field name="condition_date_diff_date_end_type"
                                               attrs="{'required': [('type','=','date_diff')]}"/>
                                    </td>
                                    <td rowspan="2">
                                        &#160; &#8211; &#160;
                                    </td>
                                    <td>
                                        <field name="condition_date_diff_date_start_type"
                                               attrs="{'required': [('type','=','date_diff')]}"/>
                                    </td>
                                    <td rowspan="2">
                                        <field name="condition_date_diff_operator"
                                               attrs="{'required': [('type','=','date_diff')]}"/>
                                    </td>
                                    <td rowspan="2">
                                        <field name="condition_date_diff_value" class="oe_inline"
                                               attrs="{'required': [('type','=','date_diff')]}"/>
                                        <field name="condition_date_diff_uom" class="oe_inline"
                                               attrs="{'required': [('type','=','date_diff')]}"/>
                                    </td>
                                    <td rowspan="2">
                                        <field name="condition_date_diff_absolute"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <field name="condition_date_diff_date_end_field"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id),('ttype', 'in', ('datetime', 'date'))]"
                                               attrs="{'required': [('type','=','date_diff'), ('condition_date_diff_date_end_type', '=','field')], 'invisible': [('condition_date_diff_date_end_type', '!=', 'field')]}"/>
                                        <field name="condition_date_diff_date_end_date"
                                               attrs="{'required': [('type','=','date_diff'), ('condition_date_diff_date_end_type', '=','date')], 'invisible': [('condition_date_diff_date_end_type', '!=', 'date')]}"/>
                                        <field name="condition_date_diff_date_end_datetime"
                                               attrs="{'required': [('type','=','date_diff'), ('condition_date_diff_date_end_type', '=','datetime')], 'invisible': [('condition_date_diff_date_end_type', '!=', 'datetime')]}"/>
                                        <div attrs="{'invisible': [('condition_date_diff_date_end_type', '!=', 'now')]}">
                                            Current date
                                        </div>
                                    </td>
                                    <td>
                                        <field name="condition_date_diff_date_start_field"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id),('ttype', 'in', ('datetime', 'date'))]"
                                               attrs="{'required': [('type','=','date_diff'), ('condition_date_diff_date_start_type', '=','field')], 'invisible': [('condition_date_diff_date_start_type', '!=', 'field')]}"/>
                                        <field name="condition_date_diff_date_start_date"
                                               attrs="{'required': [('type','=','date_diff'), ('condition_date_diff_date_start_type', '=','date')], 'invisible': [('condition_date_diff_date_start_type', '!=', 'date')]}"/>
                                        <field name="condition_date_diff_date_start_datetime"
                                               attrs="{'required': [('type','=','date_diff'), ('condition_date_diff_date_start_type', '=','datetime')], 'invisible': [('condition_date_diff_date_start_type', '!=', 'datetime')]}"/>
                                        <div attrs="{'invisible': [('condition_date_diff_date_start_type', '!=', 'now')]}">
                                            Current date
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </group>

                        <!-- 'Simple field' condition data -->
                        <group colspan="4" col="4"
                               name="group_condition_simple_field"
                               attrs="{'invisible': [('type', '!=', 'simple_field')]}">
                            <span><field name="condition_simple_field_type"
                                         invisible="1"/></span>
                            <table colspan="4" class="generic_condition_definition">
                                <tr>
                                    <td>
                                        <label string="Field"/>
                                    </td>
                                    <td>
                                        <label string="Operator"/>
                                    </td>
                                    <td>
                                        <label string="Value"
                                               attrs="{'invisible': [('condition_simple_field_type', '=', 'boolean')]}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <field name="condition_simple_field_field_id"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id), ('ttype', 'in', ('boolean', 'char', 'text', 'html', 'float', 'integer', 'selection'))]"
                                               attrs="{'required': [('type','=','simple_field')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_simple_field_selection_operator"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', '=', 'selection')], 'invisible': [('condition_simple_field_type', '!=', 'selection')]}"/>
                                        <field name="condition_simple_field_number_operator"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', 'in', ('float', 'integer'))], 'invisible': [('condition_simple_field_type', 'not in', ('float', 'integer'))]}"/>
                                        <field name="condition_simple_field_string_operator"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', 'in', ('char', 'text'))], 'invisible': [('condition_simple_field_type', 'not in', ('char', 'text'))]}"/>
                                        <field name="condition_simple_field_string_operator_html"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', '=', 'html')], 'invisible': [('condition_simple_field_type', '!=', 'html')]}"/>
                                        <div>
                                            <span
                                                    attrs="{'invisible': ['|', ('condition_simple_field_type', 'not in', ('char', 'text', 'html')),('condition_simple_field_string_operator', 'in', ('set', 'not set'))]}">
                                                <field name="condition_simple_field_string_operator_icase"/>
                                                <label for="condition_simple_field_string_operator_icase"/>
                                            </span>
                                        </div>
                                        <div>
                                            <span
                                                    attrs="{'invisible': ['|', ('condition_simple_field_type', 'not in', ('char', 'text', 'html')),('condition_simple_field_string_operator', 'in', ('set', 'not set'))]}">
                                                <field name="condition_simple_field_string_operator_regex"/>
                                                <label for="condition_simple_field_string_operator_regex"/>
                                            </span>
                                        </div>
                                        <field name="condition_simple_field_value_boolean"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', '=', 'boolean')], 'invisible': [('condition_simple_field_type', '!=', 'boolean')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_simple_field_value_char"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', 'in', ('char', 'text', 'html'))], 'invisible': ['|', ('condition_simple_field_type', 'not in', ('char', 'text', 'html')), ('condition_simple_field_string_operator', 'in', ('set', 'not set'))]}"/>
                                        <field name="condition_simple_field_value_integer"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', '=', 'integer')], 'invisible': [('condition_simple_field_type', '!=', 'integer')]}"/>
                                        <field name="condition_simple_field_value_float"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', '=', 'float')], 'invisible': [('condition_simple_field_type', '!=', 'float')]}"/>
                                        <field name="condition_simple_field_value_selection"
                                               widget="fake_selection"
                                               selection_field="condition_simple_field_field_id"
                                               attrs="{'required': [('type','=','simple_field'), ('condition_simple_field_type', '=', 'selection')], 'invisible': ['|', ('condition_simple_field_type', '!=', 'selection'), ('condition_simple_field_selection_operator', 'in', ('set', 'not set'))]}"/>
                                    </td>
                                </tr>
                            </table>
                        </group>
                        <!-- 'Related field' condition data -->
                        <group colspan="4" col="4"
                               name="group_condition_related_field"
                               attrs="{'invisible': [('type', '!=', 'related_field')]}">
                            <span><field name="condition_related_field_model"
                                         invisible="1"/></span>
                            <table colspan="4" class="generic_condition_definition">
                                <tr>
                                    <td>

                                        <label string="Field"/>
                                    </td>
                                    <td>
                                        <label string="Operator"/>
                                    </td>
                                    <td>
                                        <label string="Value"
                                               attrs="{'invisible': [('condition_related_field_operator', 'in', ('set', 'not set'))]}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <field name="condition_related_field_field_id"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id), ('ttype', 'in', ('many2one', 'many2many'))]"
                                               attrs="{'required': [('type','=','related_field')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_related_field_operator"
                                               attrs="{'required': [('type','=','related_field')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_related_field_value_id"
                                               widget="generic_m2o" model_field="condition_related_field_model"
                                               attrs="{'required': [('type','=','related_field'), ('condition_related_field_operator', '=', 'contains')], 'invisible': [('condition_related_field_operator', 'in', ('set', 'not set'))]}"/>
                                    </td>
                                </tr>
                            </table>
                        </group>
                        <!-- 'Monetary field' condition data -->
                        <group colspan="4" col="4"
                               name="group_condition_simple_field"
                               attrs="{'invisible': [('type', '!=', 'monetary_field')]}">
                            <table colspan="4" class="generic_condition_definition">
                                <tr>
                                    <td>
                                        <label string="Field"/>
                                    </td>
                                    <td>
                                        <label string="Operator"/>
                                    </td>
                                    <td>
                                        <label string="Result"/>
                                    </td>
                                    <td>
                                        <label string="Accounting date"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <field name="condition_monetary_field_id"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id), ('ttype', '=', 'monetary')]"
                                               attrs="{'required': [('type','=','monetary_field')]}"
                                               placeholder="Field"
                                               options="{'no_create': True}"/>
                                    </td>
                                    <td>
                                        <field name="condition_monetary_operator"
                                               attrs="{'required': [('type','=','monetary_field')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_monetary_value"
                                               attrs="{'required': [('type', '=', 'monetary_field')]}"/>
                                    </td>
                                    <td>
                                        <field name="condition_monetary_curency_date_type"
                                               attrs="{'required': [('type','=','monetary_field')]}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <field name="condition_monetary_currency_field_id"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id), ('relation', '=', 'res.currency')]"
                                               attrs="{'required': [('type','=','monetary_field')]}"
                                               placeholder="Currency field"
                                               options="{'no_create': True}"/>
                                    </td>
                                    <td>
                                    </td>
                                    <td>
                                        <field name="condition_monetary_value_currency_id"
                                               attrs="{'required': [('type', '=', 'monetary_field')]}"
                                               placeholder="Currency"
                                               options="{'no_create': True}"/>
                                    </td>
                                    <td>
                                        <field name="condition_monetary_curency_date_field_id"
                                               placeholder="Date field"
                                               options="{'no_create': True}"
                                               context="{'default_model_id': model_id}"
                                               domain="[('model_id','=',model_id),('ttype', 'in', ('datetime', 'date'))]"
                                               attrs="{'required': [('type','=','monetary_field'), ('condition_monetary_curency_date_type', '=','field')], 'invisible': [('condition_monetary_curency_date_type', '!=', 'field')]}"/>
                                        <field name="condition_monetary_curency_date_date"
                                               attrs="{'required': [('type','=','monetary_field'), ('condition_monetary_curency_date_type', '=','date')], 'invisible': [('condition_monetary_curency_date_type', '!=', 'date')]}"/>
                                        <label string="Current date"
                                               attrs="{'invisible': [('condition_monetary_curency_date_type', '!=', 'now')]}"/>
                                    </td>
                                </tr>
                            </table>
                        </group>
                    </group>
                    <group colspan="4" string="Description">
                        <field name="description" nolabel="1"
                               placeholder="Description..."/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="generic_condition_action" model="ir.actions.act_window">
        <field name="name">Generic Conditions</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">generic.condition</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!--menus -->
    <menuitem id="menu_generic_condition"
              name="Generic Conditions"
              parent="menu_generic_condition_root" sequence="60"
              action="generic_condition_action"/>
</odoo>
